name: TTS

on:
  push:
    branches: [main]

jobs:
  generate-tts:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Generate TTS audio
        run: npx speak-mintlify@latest generate .
        env:
          FISH_API_KEY: ${{ secrets.FISH_API_KEY }}
          S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
          S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          S3_PUBLIC_URL: ${{ vars.S3_PUBLIC_URL }}
          S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}

      - name: Cleanup Orphaned Audio
        run: npx speak-mintlify@latest cleanup .
        env:
          S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
          S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          S3_PUBLIC_URL: ${{ vars.S3_PUBLIC_URL }}
          S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: 'chore: update TTS audio'
          title: 'chore: update TTS Audio'
          body: 'Auto-generated TTS audio for updated documentation'
          branch: chore/tts-updates
          delete-branch: true
          token: ${{ secrets.BOT_TOKEN }}
          author: ${{ vars.BOT_NAME }} <${{ vars.BOT_EMAIL }}>
          committer: ${{ vars.BOT_NAME }} <${{ vars.BOT_EMAIL }}>
